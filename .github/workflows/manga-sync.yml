name: Manga Sync
on:
  schedule:
    # Roughly 8am NZT each day
    # I've been reading a lot of One Piece lately so this changes
    # daily but I'll bump it back down when I'm up to date
    - cron: '0 18 * * *'
  workflow_dispatch:
jobs:
  sync:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Python
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11.0"
      - name: Install dependencies
        run: python -m pip install -r scripts/requirements.txt
      - name: Audit links
        run: python scripts/sync-manga.py
      - name: Commit manga changes
        env:
          # We use a PAT in order to trigger other workflows on commit
          # See https://github.community/t/push-from-action-does-not-trigger-subsequent-action/16854/2
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set -eux
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -a -m "Manga list has been updated"
          else
            exit 0
          fi
      
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ github.ref }}
