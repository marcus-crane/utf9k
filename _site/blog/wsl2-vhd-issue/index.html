<!doctype html>
<html lang="en">
  <head>
    <title>utf9k</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="theme-color" content="#eaebe3" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1f2738" media="(prefers-color-scheme: dark)" />
    <meta name="author" content="Marcus Crane" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" href="/favicon.png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/favicon.png" />
    <link rel="me" href="mailto:hello@utf9k.net" />
    <link rel="me" href="https://mastodon.nz/@utf9k" />
    <link rel="me" href="https://twitter.com/sentreh" />
    <link rel="me" href="https://github.com/marcus-crane" />
    <link rel="webmention" href="https://webmention.io/utf9k.net/webmention" />
    <link rel="pingback" href="https://webmention.io/utf9k.net/xmlrpc" />
    <link rel="stylesheet" href="https://unpkg.com/littlefoot@4.0.1/dist/littlefoot.css" />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <header class="navigation">
      <a href="/" id="logo">
        <img src="/favicon.png" alt="utf9k" width="16px" height="16px" />
        <span>utf9k</span>
      </a>
      <nav>
        <li><a href="/blog/">Blog</a></li>
        <span>//</span>
        <li><a href="/projects/">Projects</a></li>
        <span>//</span>
        <li><a href="/about/">About</a></li>
        <span>//</span>
        <li><a href="/questions/">Questions</a></li>
        <span>//</span>
        <li><a href="/rss.xml">RSS</a></li>
      </nav>
    </header>
    <div id="content">
      <article>
        <header>
          <h1>Fixing a WSL2 VHD conversion issue</h1>

          <div id="post-meta">
            <time datetime="Fri Jul 19 2019 23:00:00 GMT+1200 (New Zealand Standard Time)">July 19, 2019</time> · Around
            2 minutes
          </div>
        </header>
        <div id="post-body">
          <p>
            I recently started running the Windows Insider builds on my desktop so that I could play around with the new
            Windows Subsystem for Linux but I ran into some trouble. Before I get into the fix, here's a little bit of
            history
          </p>
          <h2 id="the-history">
            <a aria-hidden="true" class="jumplink" tabindex="-1" href="#the-history">¶ </a>The history
          </h2>
          <p>
            For the unfamiliar, it's a way to run Linux applications inside of a Windows environment using a lightweight
            VM.
          </p>
          <p>
            For the familiar, you may have heard of WSL 1, which essentially translated Linux system calls into their
            appropriate NT kernel counterparts. The downside meant that things were kind of slow, and not everything
            worked as you would hope.
          </p>
          <p>
            The biggest downside was perhaps USB devices, in that there were no drivers to support them. Personally, I
            was unable to use the Yubikey NEO I had at the time, given that
            <a href="https://github.com/microsoft/WSL/issues/1521">smart cards had no support</a>. Anyone using USB
            debug interfaces such as <a href="https://github.com/microsoft/WSL/issues/2185">JTAG</a> or
            <a href="https://github.com/microsoft/WSL/issues/2195">ADB</a> was out of luck too.
          </p>
          <p>
            Thankfully, this should hopefully be in the past now with the
            <a href="https://devblogs.microsoft.com/commandline/announcing-wsl-2">announcement of WSL 2</a>, a virtual
            machine that's supposed to be so light, it's not like those other slow virtual machines you think of.
          </p>
          <h2 id="the-fix"><a aria-hidden="true" class="jumplink" tabindex="-1" href="#the-fix">¶ </a>The fix</h2>
          <p>
            Long story short, I dove in by following the installation instructions and hit a brick wall once I got to
            the second step.
          </p>
          <div data-rehype-pretty-code-fragment="">
            <pre
              class="rose-pine-moon"
              style="background-color: #232136"
              tabindex="0"
              data-language="powershell"
              data-theme="dark"
            ><code data-language="powershell" data-theme="dark" style="display: grid;"><span data-line=""><span style="color: #E0DEF4">PS C:\WINDOWS\system3</span><span style="color: #3E8FB0">2></span><span style="color: #E0DEF4"> wsl </span><span style="color: #3E8FB0">--</span><span style="color: #EB6F92; font-style: italic">set-version</span><span style="color: #E0DEF4"> Ubuntu </span><span style="color: #EA9A97">2</span></span>
<span data-line=""><span style="color: #E0DEF4">Conversion </span><span style="color: #3E8FB0">in</span><span style="color: #E0DEF4"> progress</span><span style="color: #3E8FB0">,</span><span style="color: #E0DEF4"> this may take a few minutes...</span></span>
<span data-line=""><span style="color: #3E8FB0">For</span><span style="color: #E0DEF4"> information on key differences with WSL </span><span style="color: #EA9A97">2</span><span style="color: #E0DEF4"> please visit https:</span><span style="color: #3E8FB0">//</span><span style="color: #E0DEF4">aka.ms</span><span style="color: #3E8FB0">/</span><span style="color: #E0DEF4">wsl2</span></span>
<span data-line=""><span style="color: #E0DEF4">The requested operation could not be completed due to a virtual disk system limitation.</span></span>
<span data-line=""><span style="color: #E0DEF4">Virtual hard disk files must be uncompressed and unencrypted and must not be sparse.</span></span></code></pre>
            <pre
              class="rose-pine-dawn"
              style="background-color: #faf4ed"
              tabindex="0"
              data-language="powershell"
              data-theme="light"
            ><code data-language="powershell" data-theme="light" style="display: grid;"><span data-line=""><span style="color: #575279">PS C:\WINDOWS\system3</span><span style="color: #286983">2></span><span style="color: #575279"> wsl </span><span style="color: #286983">--</span><span style="color: #B4637A; font-style: italic">set-version</span><span style="color: #575279"> Ubuntu </span><span style="color: #D7827E">2</span></span>
<span data-line=""><span style="color: #575279">Conversion </span><span style="color: #286983">in</span><span style="color: #575279"> progress</span><span style="color: #286983">,</span><span style="color: #575279"> this may take a few minutes...</span></span>
<span data-line=""><span style="color: #286983">For</span><span style="color: #575279"> information on key differences with WSL </span><span style="color: #D7827E">2</span><span style="color: #575279"> please visit https:</span><span style="color: #286983">//</span><span style="color: #575279">aka.ms</span><span style="color: #286983">/</span><span style="color: #575279">wsl2</span></span>
<span data-line=""><span style="color: #575279">The requested operation could not be completed due to a virtual disk system limitation.</span></span>
<span data-line=""><span style="color: #575279">Virtual hard disk files must be uncompressed and unencrypted and must not be sparse.</span></span></code></pre>
          </div>
          <p>
            Upon trying to convert my WSL distros to Version 2, they complained about a virtual disk system limitation.
            I actually put this on the backburner for months until coming back to it today and the fix felt dumb.
          </p>
          <p>
            You'd never know it but your WSL packages live under
            <code>%LOCALAPPDATA%/packages/&#x3C;distro title surrounded by nonsense></code>. In my case, Debian lives at
            <code>C:\Users\Marcus\AppData\Local\Packages\TheDebianProject.DebianGNULinux_76v4gfsz19hv4</code>. If you
            visit your distro's respective folder, you'll find no virtual disk image in sight.
          </p>
          <p>
            The terms "uncompressed and unencrypted" tipped me off to check those blasted "advanced settings". Under
            <code>Right Click -> Properties -> General -> Advanced</code>, I spotted
            <code>Compress contents to save disk space</code> was ticked for some reason. Unchecking it, then rerunning
            the WSL 1 -> 2 conversion worked as you'd hope.
          </p>
          <p>
            <center>
              <figure>
                <img
                  src="https://cdn.utf9k.net/blog/wsl2-vhd-issue/compressed.png"
                  alt="A screenshot showing Windows Explorer. It is open to C:/Users/Marcus/AppData/Local/Packages. A folder is highlighted to indicate it was recently clicked on. The properties window for that folder is visible showing metadata. Overlaying the properties window is the Advanced Attributes window where a checkbox labelled &#x27;Compress contents to save disk space&#x27; is checked. The author is showing that you should uncheck that box to fix the issue described in this post."
                />
              </figure>
            </center>
          </p>
          <p>
            So, if you run into this issue, have a poke around your packages and hopefully you'll be on your way to a
            nice, properly Linux-y home on Windows.
          </p>
        </div>
      </article>

      <script src="https://unpkg.com/littlefoot@4.0.1/dist/littlefoot.js" type="text/javascript"></script>
      <script type="text/javascript">
        littlefoot.littlefoot(); // Pass any littlefoot settings here.
      </script>
    </div>
    <div id="fullscreen"></div>
    <script type="module">
      import "/js/image-viewer.js";
    </script>
  </body>
</html>
