{{ define "main" }}
  <div class="inline-header">
    <h1>
      <span class="site-icon-wrapper" onclick="newGag()">
        <img src="https://utf9k.net/favicon.png" alt="A robot icon" class="site-icon">
        <span class="speech-bubble robot-gag"></span>
      </span>
      <a href="/">
        <span class="site-name">{{ .Site.Title }}</span>
      </a>
    </h1>
  </div>

  <div class="article-header">
    <h1>{{ .Title }}</h1>
    {{ with .Params.description }}<div class="desc">{{ . }}</div>{{ end }}
    {{ if or .Date .Params.tags }}
    <div class="article-meta">
      {{ with .Date }}<div><span class="meta-label">Published</span><span class="meta-value">{{ .Format "2006-01-02" }}</span></div>{{ end }}
      {{ with .Params.tags }}<div><span class="meta-label">Tags</span>{{ range . }}<span class="meta-value">{{ . }}</span>{{ end }}</div>{{ end }}
    </div>
    {{ end }}
  </div>

  <div class="article-wrapper">
    <article class="content">
      {{ if strings.Contains .TableOfContents "<li>" }}
      <aside class="toc-left">
        <div class="toc-title">Contents</div>
        {{ .TableOfContents }}
        <div class="toc-title">Settings</div>
        <div class="theme-toggle">
          <button type="button" data-theme="light" title="Light Mode" aria-label="Light mode">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
          </button>
          <button type="button" data-theme="system" class="active" title="Follow OS/browser preference" aria-label="Follow OS/browser preference">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </button>
          <button type="button" data-theme="dark" title="Dark Mode" aria-label="Dark mode">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          </button>
        </div>
      </aside>
      {{ end }}
      {{ .Content }}
    </article>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let activePreview = null;
      let lastMousePos = { x: 0, y: 0 };
      let mouseTracker = null;

      function isMouseOverElement(e, element) {
        const rect = element.getBoundingClientRect();
        return e.clientX >= rect.left && e.clientX <= rect.right &&
               e.clientY >= rect.top && e.clientY <= rect.bottom;
      }

      function isMovingTowardsPreview(lastPos, currentPos, preview) {
        const rect = preview.getBoundingClientRect();
        const targetX = rect.left + rect.width / 2;
        const targetY = rect.top + rect.height / 2;

        const toTargetX = targetX - currentPos.x;
        const toTargetY = targetY - currentPos.y;
        const moveX = currentPos.x - lastPos.x;
        const moveY = currentPos.y - lastPos.y;

        const movementMagnitude = Math.hypot(moveX, moveY);
        const targetMagnitude = Math.hypot(toTargetX, toTargetY);

        if (movementMagnitude < 1 || targetMagnitude < 1) return true;

        const dotProduct = (moveX * toTargetX + moveY * toTargetY) / (movementMagnitude * targetMagnitude);
        return dotProduct > -0.5;
      }

      function hidePreview() {
        if (activePreview) {
          activePreview.style.display = 'none';
          activePreview = null;
        }
        if (mouseTracker) {
          document.removeEventListener('mousemove', mouseTracker);
          mouseTracker = null;
        }
      }

      function trackMouseUntilAway(preview) {
        let framesMovingAway = 0;

        mouseTracker = function(e) {
          const currentPos = { x: e.clientX, y: e.clientY };

          if (isMouseOverElement(e, preview)) {
            framesMovingAway = 0;
            lastMousePos = currentPos;
            return;
          }

          const isStationary = Math.hypot(currentPos.x - lastMousePos.x, currentPos.y - lastMousePos.y) < 2;
          const isMovingTowards = isMovingTowardsPreview(lastMousePos, currentPos, preview);

          if (isStationary || isMovingTowards) {
            framesMovingAway = 0;
          } else {
            framesMovingAway++;
          }

          if (framesMovingAway > 3) {
            hidePreview();
          }

          lastMousePos = currentPos;
        };

        document.addEventListener('mousemove', mouseTracker);
      }

      function createPreviewElement(footnoteNum, footnoteText) {
        const preview = document.createElement('span');
        preview.className = 'footnote-preview';
        preview.setAttribute('data-num', footnoteNum + '.');
        preview.textContent = footnoteText;
        return preview;
      }

      function wrapFootnoteReference(ref) {
        const wrapper = document.createElement('span');
        wrapper.className = 'footnote-ref';
        ref.parentNode.insertBefore(wrapper, ref);
        wrapper.appendChild(ref);
        return wrapper;
      }

      function setupFootnotePreview(ref) {
        const link = ref.querySelector('a');
        if (!link) return;

        const footnoteId = link.getAttribute('href').replace(/:/g, '\\:');
        const footnoteElement = document.querySelector(footnoteId);
        if (!footnoteElement) return;

        const footnoteText = footnoteElement.textContent.replace(/↩.*$/, '').trim();
        const footnoteNum = ref.id.replace('fnref:', '');

        const wrapper = wrapFootnoteReference(ref);
        const preview = createPreviewElement(footnoteNum, footnoteText);
        wrapper.appendChild(preview);

        wrapper.addEventListener('mouseenter', function(e) {
          if (activePreview && activePreview !== preview) hidePreview();
          preview.style.display = 'block';
          activePreview = preview;
          lastMousePos = { x: e.clientX, y: e.clientY };
        });

        wrapper.addEventListener('mouseleave', function(e) {
          lastMousePos = { x: e.clientX, y: e.clientY };
          trackMouseUntilAway(preview);
        });

        preview.addEventListener('mouseenter', function() {
          if (mouseTracker) {
            document.removeEventListener('mousemove', mouseTracker);
            mouseTracker = null;
          }
        });

        preview.addEventListener('mouseleave', function(e) {
          lastMousePos = { x: e.clientX, y: e.clientY };
          trackMouseUntilAway(preview);
        });
      }

      function setupFootnotesSection() {
        const footnotes = document.querySelector('.footnotes');
        if (!footnotes) return;

        footnotes.className = 'footnotes-section';

        const hr = footnotes.querySelector('hr');
        if (hr) hr.remove();

        const heading = document.createElement('h2');
        heading.id = 'footnotes';
        heading.textContent = 'Footnotes';
        footnotes.insertBefore(heading, footnotes.firstChild);

        document.querySelectorAll('.toc nav > ul, .toc-inline nav > ul, .toc-left nav > ul').forEach(function(tocList) {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#footnotes';
          a.textContent = 'Footnotes';
          li.appendChild(a);
          tocList.appendChild(li);
        });
      }

      document.querySelectorAll('sup[id^="fnref"]').forEach(setupFootnotePreview);

      document.querySelectorAll('.footnote-ref').forEach(function(ref) {
        var node = ref.previousSibling;
        while (node && node.nodeType === 3 && node.textContent.trim() === '') {
          node = node.previousSibling;
        }
        if (node && node.nodeType === 1 && node.classList.contains('footnote-ref')) {
          ref.classList.add('adjacent');
        }
      });

      document.querySelectorAll('.footnotes a[href^="#fnref"]').forEach(function(link) {
        link.className = 'footnote-backref';
        link.textContent = '↩';
      });

      setupFootnotesSection();
    });
  </script>
  {{ partial "preview.html" ".content figure.image-figure" }}
{{ end }}