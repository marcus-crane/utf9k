<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} // {{ .Site.Title }}{{ end }}</title>

  {{ range .AlternativeOutputFormats }}
  <link rel="{{ .Rel }}" type="{{ .MediaType.Type }}" href="{{ .Permalink | safeURL }}">
  {{ end }}

  {{ with resources.Get "css/style.css" | postCSS }}
  <style>
  {{ .Content | safeCSS }}
  </style>
  {{ end }}
</head>
<body>
  <div class="mobile-overlay" onclick="toggleMenu()"></div>
  <div class="layout">
    {{ partial "sidebar.html" . }}

    <main class="main">
      <div class="mobile-header">
        <a href="/" class="mobile-logo">
          <img src="https://utf9k.net/favicon.png" alt="" class="site-icon">
          <span class="site-name">utf9k</span>
        </a>
        <button class="menu-toggle" onclick="toggleMenu()">+ MENU</button>
      </div>

      {{ block "main" .}}{{ end }}

      {{ partial "footer.html" . }}
    </main>
  </div>

  <script>
    function toggleMenu() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.mobile-overlay').classList.toggle('open');
    }

    // As busted as this looks (in source code), it renders a valid JS array
    const gags = {{ .Site.Data.gags }};

    function newGag() {
      document.getElementById('robot-gag').textContent = gags[Math.floor(Math.random() * gags.length)];
    }

    newGag();

    (function() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

      function getSavedTheme() {
        return localStorage.getItem('theme') || 'system';
      }

      function applyTheme(theme) {
        const isDark = theme === 'dark' || (theme === 'system' && prefersDark.matches);
        document.body.classList.toggle('dark', isDark);
      }

      function setTheme(theme) {
        localStorage.setItem('theme', theme);
        applyTheme(theme);
        document.querySelectorAll('.theme-toggle button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.theme === theme);
        });
      }

      const savedTheme = getSavedTheme();
      applyTheme(savedTheme);

      document.querySelectorAll('.theme-toggle button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === savedTheme);
        btn.addEventListener('click', () => setTheme(btn.dataset.theme));
      })

      prefersDark.addEventListener('change', () => {
        if (getSavedTheme() === 'system') {
          applyTheme('system');
        }
      })
    })();

    // Image preview: click to show on desktop, direct link on mobile
    (function() {
      const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      if (isMobile) return;

      document.querySelectorAll('.content figure.image-figure').forEach(figure => {
        const link = figure.querySelector('a');
        const preview = figure.querySelector('.preview');
        if (!link || !preview) return;

        link.addEventListener('click', e => {
          e.preventDefault();
          const isActive = preview.classList.contains('active');
          preview.classList.toggle('active');
          preview.classList.toggle('clicked', !isActive);
        });

        let startX, startY;
        preview.addEventListener('mousedown', e => {
          startX = e.clientX;
          startY = e.clientY;
        });

        preview.addEventListener('click', e => {
          if (e.button !== 0) return;
          const dx = Math.abs(e.clientX - startX);
          const dy = Math.abs(e.clientY - startY);
          if (dx < 5 && dy < 5) {
            preview.classList.remove('active', 'clicked');
          }
        });

        // Shift+hover to preview
        figure.addEventListener('mouseenter', e => {
          figure.classList.add('hovered');
          if (e.shiftKey && !preview.classList.contains('clicked')) {
            // Close other shift-opened previews first
            document.querySelectorAll('.content figure.image-figure .preview.active').forEach(p => {
              if (!p.classList.contains('clicked')) p.classList.remove('active');
            });
            preview.classList.add('active');
          }
        });

        figure.addEventListener('mouseleave', e => {
          figure.classList.remove('hovered');
          // Only close if shift not held (let mouseenter on next image handle transition)
          if (!e.shiftKey && !preview.classList.contains('clicked')) {
            preview.classList.remove('active');
          }
        });
      });

      document.addEventListener('keydown', e => {
        if (e.key === 'Shift') {
          document.querySelectorAll('.content figure.image-figure.hovered').forEach(figure => {
            const preview = figure.querySelector('.preview');
            if (preview && !preview.classList.contains('clicked')) {
              preview.classList.add('active');
            }
          });
        }
      });

      document.addEventListener('keyup', e => {
        if (e.key === 'Shift') {
          document.querySelectorAll('.content figure.image-figure .preview.active').forEach(p => {
            if (!p.classList.contains('clicked')) p.classList.remove('active');
          });
        }
      });

      document.addEventListener('click', e => {
        if (!e.target.closest('.content figure.image-figure')) {
          document.querySelectorAll('.preview.active').forEach(p => p.classList.remove('active', 'clicked'));
        }
      });

      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.preview.active').forEach(p => p.classList.remove('active', 'clicked'));
        }
      });
    })();
  </script>
</body>
</html>