{{ define "main" }}
<div class="experiments-page">
  <h1>History Display Experiments</h1>
  <p class="experiments-intro">Four different approaches to displaying playback history. Click thumbnails to preview, shift+hover for quick preview.</p>

  <!-- Style 1: Horizontal Thumbnail Row -->
  <section class="experiment">
    <h2>1. Horizontal Thumbnail Row</h2>
    <p>Scrollable row of cover art, similar to the media shelf.</p>
    <div class="block block-filled">
      <div class="label label-iris">History</div>
      <div class="history-horizontal" id="history-horizontal"></div>
    </div>
  </section>

  <!-- Style 2: Timeline -->
  <section class="experiment">
    <h2>2. Timeline Style</h2>
    <p>Vertical timeline with connecting line and relative timestamps.</p>
    <div class="block block-filled">
      <div class="label label-iris">History</div>
      <div class="history-timeline" id="history-timeline"></div>
    </div>
  </section>

  <!-- Style 3: Grid of Covers -->
  <section class="experiment">
    <h2>3. Grid of Covers</h2>
    <p>Compact grid showing just the cover art.</p>
    <div class="block block-filled">
      <div class="label label-iris">History</div>
      <div class="history-grid" id="history-grid"></div>
    </div>
  </section>

  <!-- Style 4: Compact Cards -->
  <section class="experiment">
    <h2>4. Compact Cards</h2>
    <p>Mini player-style cards with thumbnail and metadata.</p>
    <div class="block block-filled">
      <div class="label label-iris">History</div>
      <div class="history-cards" id="history-cards"></div>
    </div>
  </section>

  <!-- Style 5: Mixed Media -->
  <section class="experiment">
    <h2>5. Mixed Media</h2>
    <p>Category-colored cards showing manga, games, and movies.</p>
    <div class="block block-filled">
      <div class="label label-iris">History</div>
      <div class="history-mixed" id="history-mixed"></div>
    </div>
  </section>
</div>

<style>
.experiments-page {
  max-width: 900px;
}

.experiments-page h1 {
  margin-bottom: 0.5rem;
}

.experiments-intro {
  color: var(--muted);
  margin-bottom: 2rem;
}

.experiment {
  margin-bottom: 3rem;
}

.experiment h2 {
  font-size: 1.1rem;
  margin-bottom: 0.25rem;
}

.experiment > p {
  color: var(--muted);
  font-size: 0.85rem;
  margin-bottom: 1rem;
}

/* Style 1: Horizontal Thumbnail Row */
.history-horizontal {
  display: flex;
  gap: 0.75rem;
  overflow-x: auto;
  padding: 0.5rem 0;
  scrollbar-width: thin;
}

.history-horizontal::-webkit-scrollbar {
  height: 6px;
}

.history-horizontal::-webkit-scrollbar-thumb {
  background: var(--muted);
  border-radius: 3px;
}

.history-horizontal .history-thumb {
  flex-shrink: 0;
  position: relative;
  cursor: pointer;
}

.history-horizontal .history-thumb img {
  height: 80px;
  width: auto;
  border-radius: 4px;
  border: var(--border-normal) solid var(--iris);
  transition: border-color 0.15s, transform 0.15s;
}

.history-horizontal .history-thumb:hover img {
  border-color: var(--love);
  transform: scale(1.05);
}

/* Style 2: Timeline */
.history-timeline {
  position: relative;
  padding-left: 2rem;
}

.history-timeline::before {
  content: '';
  position: absolute;
  left: 0.5rem;
  top: 0.5rem;
  bottom: 0.5rem;
  width: 2px;
  background: var(--highlight-med);
}

.history-timeline .timeline-item {
  position: relative;
  display: flex;
  gap: 1rem;
  padding: 0.75rem 0;
  align-items: flex-start;
}

.history-timeline .timeline-item::before {
  content: '';
  position: absolute;
  left: -1.65rem;
  top: 1.1rem;
  width: 10px;
  height: 10px;
  background: var(--iris);
  border-radius: 50%;
  border: 2px solid var(--surface);
}

.history-timeline .timeline-thumb {
  position: relative;
  flex-shrink: 0;
  cursor: pointer;
}

.history-timeline .timeline-thumb img {
  height: 60px;
  width: auto;
  border-radius: 4px;
  border: var(--border-normal) solid var(--overlay);
  transition: border-color 0.15s;
}

.history-timeline .timeline-thumb:hover img {
  border-color: var(--iris);
}

.history-timeline .timeline-meta {
  flex: 1;
  min-width: 0;
}

.history-timeline .timeline-title {
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.history-timeline .timeline-subtitle {
  color: var(--muted);
  font-size: 0.85rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.history-timeline .timeline-time {
  color: var(--subtle);
  font-size: 0.75rem;
  margin-top: 0.25rem;
}

/* Style 3: Grid of Covers */
.history-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  gap: 0.5rem;
  padding: 0.5rem 0;
}

.history-grid .grid-thumb {
  position: relative;
  aspect-ratio: 1;
  cursor: pointer;
  overflow: hidden;
  border-radius: 4px;
  border: var(--border-normal) solid var(--overlay);
  transition: border-color 0.15s, transform 0.15s;
}

.history-grid .grid-thumb:hover {
  border-color: var(--iris);
  transform: scale(1.05);
  z-index: 1;
}

.history-grid .grid-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Style 4: Compact Cards */
.history-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.6rem;
  padding: 0.5rem 0;
}

.history-cards .card-item {
  position: relative;
  aspect-ratio: 3 / 4;
  border-radius: 6px;
  border: var(--border-normal) solid var(--highlight-low);
  overflow: hidden;
  cursor: pointer;
  transition: border-color 0.15s, transform 0.15s;
}

.history-cards .card-item:hover {
  border-color: var(--iris);
  transform: scale(1.02);
}

.history-cards .card-item > img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.history-cards .card-meta {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 2.5rem 0.6rem 0.6rem;
  background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.6) 50%, transparent 100%);
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
}

.history-cards .card-action {
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #fff;
  font-weight: 600;
  background: var(--iris);
  padding: 0.15rem 0.4rem;
  border-radius: 3px;
  width: fit-content;
}

.history-cards .card-title {
  font-weight: 600;
  font-size: 0.85rem;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
}

.history-cards .card-subtitle {
  color: rgba(255,255,255,0.7);
  font-size: 0.75rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.history-cards .card-time {
  color: rgba(255,255,255,0.5);
  font-size: 0.65rem;
}

/* Style 5: Mixed Media */
.history-mixed {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.6rem;
  padding: 0.5rem 0;
}

.history-mixed .mixed-item {
  position: relative;
  aspect-ratio: 3 / 4;
  border-radius: 6px;
  overflow: hidden;
  cursor: pointer;
  transition: border-color 0.15s, transform 0.15s;
  border: 2px solid var(--overlay);
}

.history-mixed .mixed-item:hover {
  transform: scale(1.02);
}

.history-mixed .mixed-item.cat-manga { border-color: var(--love); }
.history-mixed .mixed-item.cat-gaming { border-color: var(--pine); }
.history-mixed .mixed-item.cat-episode { border-color: var(--iris); }
.history-mixed .mixed-item.cat-movie { border-color: var(--gold); }
.history-mixed .mixed-item.cat-track { border-color: var(--foam); }
.history-mixed .mixed-item.cat-podcast_episode { border-color: var(--rose); }

.history-mixed .mixed-item.now-playing { border-color: var(--love); }
.history-mixed .mixed-item.now-playing .mixed-category { background: var(--love); }

.history-mixed .mixed-item > img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.history-mixed .mixed-meta {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 2rem 0.5rem 0.5rem;
  background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.6) 50%, transparent 100%);
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
}

.history-mixed .mixed-category {
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #fff;
  font-weight: 600;
  padding: 0.15rem 0.35rem;
  border-radius: 3px;
  width: fit-content;
}

.history-mixed .cat-manga .mixed-category { background: var(--love); }
.history-mixed .cat-gaming .mixed-category { background: var(--pine); }
.history-mixed .cat-episode .mixed-category { background: var(--iris); }
.history-mixed .cat-movie .mixed-category { background: var(--gold); }
.history-mixed .cat-track .mixed-category { background: var(--foam); }
.history-mixed .cat-podcast_episode .mixed-category { background: var(--rose); }

.history-mixed .mixed-title {
  font-weight: 600;
  font-size: 0.8rem;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
}

.history-mixed .mixed-subtitle {
  color: rgba(255,255,255,0.7);
  font-size: 0.7rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.history-mixed .mixed-time {
  color: rgba(255,255,255,0.6);
  font-size: 0.55rem;
}

/* Preview styles for all history variants */
.history-horizontal .preview,
.history-timeline .preview,
.history-grid .preview,
.history-cards .preview,
.history-mixed .preview {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  background: var(--surface);
  border: var(--border-normal) solid var(--iris);
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  width: 500px;
  max-width: 90vw;
}

.history-horizontal .preview.active,
.history-timeline .preview.active,
.history-grid .preview.active,
.history-cards .preview.active,
.history-mixed .preview.active {
  display: block;
}

.history-horizontal .preview img,
.history-timeline .preview img,
.history-grid .preview img,
.history-cards .preview img,
.history-mixed .preview img {
  width: 100%;
  height: auto;
  border-radius: 4px;
}

.history-horizontal .preview-meta,
.history-timeline .preview-meta,
.history-grid .preview-meta,
.history-cards .preview-meta,
.history-mixed .preview-meta {
  margin-top: 0.75rem;
}

.history-horizontal .preview-title,
.history-timeline .preview-title,
.history-grid .preview-title,
.history-cards .preview-title,
.history-mixed .preview-title {
  font-weight: 600;
  font-size: 1.1rem;
}

.history-horizontal .preview-subtitle,
.history-timeline .preview-subtitle,
.history-grid .preview-subtitle,
.history-cards .preview-subtitle,
.history-mixed .preview-subtitle {
  color: var(--muted);
  margin-top: 0.25rem;
}

/* Episode/movie wider preview */
.preview-episode,
.preview-movie {
  width: 720px !important;
}
</style>

<script>
(function() {
  const PODCAST = 'podcast_episode';
  const MANGA = 'manga';
  const GAMING = 'gaming';
  const EPISODE = 'episode';
  const MOVIE = 'movie';
  const TRACK = 'track';

  const statusText = {
    [PODCAST]: "Listened to",
    [MANGA]: "Read",
    [GAMING]: "Played",
    [EPISODE]: "Watched",
    [MOVIE]: "Watched",
    [TRACK]: "Listened to"
  };

  function formatMangaTitle(title) {
    if (title.includes(" - ")) {
      return `Chapters ${title.replace("-", "through")}`;
    }
    return `Chapter ${title}`;
  }

  function relativeTime(item) {
    const dateStr = item.updated_at || item.created_at;
    if (!dateStr) return '';
    const timestamp = new Date(dateStr).getTime();
    if (isNaN(timestamp)) return '';
    const now = Date.now();
    const diff = (now - timestamp) / 1000;
    if (diff < 0) return '';
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
    return `${Math.floor(diff / 604800)}w ago`;
  }

  function createPreview(item, title) {
    const imgUrl = item.image.startsWith('http') ? item.image : "https://gunslinger.utf9k.net" + item.image;
    return createPreviewWithUrl(item, title, imgUrl);
  }

  function createPreviewWithUrl(item, title, imgUrl) {
    const preview = document.createElement('div');
    preview.className = `preview preview-${item.category}`;
    preview.innerHTML = `
      <img src="${imgUrl}" alt="">
      <div class="preview-meta">
        <div class="preview-title">${title}</div>
        <div class="preview-subtitle">${item.subtitle || ''}</div>
      </div>
    `;
    return preview;
  }

  function setupPreviewHandlers(thumb, preview) {
    thumb.addEventListener('click', e => {
      e.stopPropagation();
      const wasActive = preview.classList.contains('active');
      document.querySelectorAll('.preview.active').forEach(p => p.classList.remove('active', 'clicked'));
      if (!wasActive) {
        preview.classList.add('active', 'clicked');
      }
    });

    thumb.addEventListener('mouseenter', e => {
      thumb.classList.add('hovered');
      if (e.shiftKey && !preview.classList.contains('clicked')) {
        document.querySelectorAll('.preview.active').forEach(p => {
          if (!p.classList.contains('clicked')) p.classList.remove('active');
        });
        preview.classList.add('active');
      }
    });

    thumb.addEventListener('mouseleave', e => {
      thumb.classList.remove('hovered');
      if (!e.shiftKey && !preview.classList.contains('clicked')) {
        preview.classList.remove('active');
      }
    });
  }

  // Style 1: Horizontal Thumbnail Row
  function renderHorizontal(data) {
    const container = document.getElementById('history-horizontal');
    container.innerHTML = '';

    data.slice(0, 10).forEach(item => {
      let title = item.category === MANGA ? formatMangaTitle(item.title) : item.title;

      const thumb = document.createElement('div');
      thumb.className = 'history-thumb';

      const img = document.createElement('img');
      img.src = "https://gunslinger.utf9k.net" + item.image;
      img.alt = title;
      thumb.appendChild(img);

      const preview = createPreview(item, title);
      thumb.appendChild(preview);

      setupPreviewHandlers(thumb, preview);
      container.appendChild(thumb);
    });
  }

  // Style 2: Timeline
  function renderTimeline(data) {
    const container = document.getElementById('history-timeline');
    container.innerHTML = '';

    data.slice(0, 8).forEach(item => {
      let title = item.category === MANGA ? formatMangaTitle(item.title) : item.title;

      const timelineItem = document.createElement('div');
      timelineItem.className = 'timeline-item';

      const thumb = document.createElement('div');
      thumb.className = 'timeline-thumb';

      const img = document.createElement('img');
      img.src = "https://gunslinger.utf9k.net" + item.image;
      img.alt = '';
      thumb.appendChild(img);

      const preview = createPreview(item, title);
      thumb.appendChild(preview);

      setupPreviewHandlers(thumb, preview);

      const time = relativeTime(item);
      const meta = document.createElement('div');
      meta.className = 'timeline-meta';
      meta.innerHTML = `
        <div class="timeline-title">${title}</div>
        <div class="timeline-subtitle">${item.subtitle || ''}</div>
        <div class="timeline-time">${statusText[item.category] || 'Enjoyed'}${time ? ` Â· ${time}` : ''}</div>
      `;

      timelineItem.appendChild(thumb);
      timelineItem.appendChild(meta);
      container.appendChild(timelineItem);
    });
  }

  // Style 3: Grid of Covers
  function renderGrid(data) {
    const container = document.getElementById('history-grid');
    container.innerHTML = '';

    data.slice(0, 12).forEach(item => {
      let title = item.category === MANGA ? formatMangaTitle(item.title) : item.title;

      const thumb = document.createElement('div');
      thumb.className = 'grid-thumb';

      const img = document.createElement('img');
      img.src = "https://gunslinger.utf9k.net" + item.image;
      img.alt = title;
      thumb.appendChild(img);

      const preview = createPreview(item, title);
      thumb.appendChild(preview);

      setupPreviewHandlers(thumb, preview);
      container.appendChild(thumb);
    });
  }

  // Style 4: Compact Cards
  function renderCards(data) {
    const container = document.getElementById('history-cards');
    container.innerHTML = '';

    data.slice(0, 5).forEach(item => {
      let title = item.category === MANGA ? formatMangaTitle(item.title) : item.title;

      const card = document.createElement('div');
      card.className = 'card-item';

      const img = document.createElement('img');
      img.src = "https://gunslinger.utf9k.net" + item.image;
      img.alt = title;
      card.appendChild(img);

      const preview = createPreview(item, title);
      card.appendChild(preview);

      setupPreviewHandlers(card, preview);

      const time = relativeTime(item);
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.innerHTML = `
        <div class="card-action">${statusText[item.category] || 'Enjoyed'}</div>
        <div class="card-title">${title}</div>
        <div class="card-subtitle">${item.subtitle || ''}</div>
        ${time ? `<div class="card-time">${time}</div>` : ''}
      `;

      card.appendChild(meta);
      container.appendChild(card);
    });
  }

  // Style 5: Mixed Media
  function renderMixed(playing, history) {
    const container = document.getElementById('history-mixed');
    container.innerHTML = '';

    const categoryLabels = {
      [MANGA]: 'Manga',
      [GAMING]: 'Game',
      [EPISODE]: 'TV',
      [MOVIE]: 'Movie',
      [TRACK]: 'Music',
      [PODCAST]: 'Podcast'
    };

    // Combine now playing with history, avoiding duplicates
    const nowPlaying = playing && playing.length > 0 ? playing[0] : null;
    const filteredHistory = nowPlaying
      ? history.filter(h => h.id !== nowPlaying.id)
      : history;
    const items = nowPlaying
      ? [nowPlaying, ...filteredHistory.slice(0, 4)]
      : filteredHistory.slice(0, 5);

    items.forEach((item, index) => {
      const isNowPlaying = index === 0 && nowPlaying && item.is_active;
      let title = item.category === MANGA ? formatMangaTitle(item.title) : item.title;

      const card = document.createElement('div');
      card.className = `mixed-item cat-${item.category}${isNowPlaying ? ' now-playing' : ''}`;

      const imgUrl = item.image.startsWith('http') ? item.image : "https://gunslinger.utf9k.net" + item.image;

      const img = document.createElement('img');
      img.src = imgUrl;
      img.alt = title;
      card.appendChild(img);

      const preview = createPreviewWithUrl(item, title, imgUrl);
      card.appendChild(preview);

      setupPreviewHandlers(card, preview);

      const time = relativeTime(item);
      const categoryLabel = isNowPlaying
        ? 'Now'
        : (categoryLabels[item.category] || item.category);
      const meta = document.createElement('div');
      meta.className = 'mixed-meta';
      meta.innerHTML = `
        <div class="mixed-category">${categoryLabel}</div>
        <div class="mixed-subtitle">${item.subtitle || ''}</div>
        <div class="mixed-title">${title}</div>
        ${!isNowPlaying && time ? `<div class="mixed-time">${time}</div>` : ''}
      `;

      card.appendChild(meta);
      container.appendChild(card);
    });
  }

  // Fetch and render all styles
  Promise.all([
    fetch("https://gunslinger.utf9k.net/api/v4/playing").then(res => res.json()),
    fetch("https://gunslinger.utf9k.net/api/v4/history").then(res => res.json())
  ])
    .then(([playing, history]) => {
      renderHorizontal(history);
      renderTimeline(history);
      renderGrid(history);
      renderCards(history);
      renderMixed(playing, history);
    })
    .catch(err => console.error(`Failed to fetch data: ${err}`));

  // Global handlers
  document.addEventListener('keydown', e => {
    if (e.key === 'Shift') {
      document.querySelectorAll('.hovered').forEach(thumb => {
        const preview = thumb.querySelector('.preview');
        if (preview && !preview.classList.contains('clicked')) {
          preview.classList.add('active');
        }
      });
    }
    if (e.key === 'Escape') {
      document.querySelectorAll('.preview.active').forEach(p => p.classList.remove('active', 'clicked'));
    }
  });

  document.addEventListener('keyup', e => {
    if (e.key === 'Shift') {
      document.querySelectorAll('.preview.active').forEach(p => {
        if (!p.classList.contains('clicked')) p.classList.remove('active');
      });
    }
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.history-thumb') &&
        !e.target.closest('.timeline-thumb') &&
        !e.target.closest('.grid-thumb') &&
        !e.target.closest('.card-item') &&
        !e.target.closest('.mixed-item')) {
      document.querySelectorAll('.preview.active').forEach(p => p.classList.remove('active', 'clicked'));
    }
  });
})();
</script>
{{ end }}
