---
date: "2020-05-06"
title: "Setting up Emacs inside of a WSL2 distribution"
tags: ["wsl", "emacs", "unix", "linux", "windows"]
---

I've never really dedicated myself to Emacs despite being interested in [org mode](https://orgmode.org/) for a little while now.

One barrier to entry is that I had no idea how to install it on my desktop. The more places I have it installed, the quicker I can get comfortable enough to actually use it in my day to day life.

In particular, I'm trying out [Doom Emacs](https://github.com/hlissner/doom-emacs), a lightweight configuration that uses vim-style bindings.

I'm not much of a Vimmer either for the record. I'm fairly comfortable opening it up, moving around with H-J-K-L and editing here and there but I'm not much more productive than that.

Anyway, here's a short guide on how you too can get Emacs up and running on Version 2 of the [Windows for Linux subsystem](https://docs.microsoft.com/en-us/windows/wsl/about)

# An optional prerequisite

Currently, I'm using [X410](https://x410.dev/), an [X Window System](https://en.wikipedia.org/wiki/X_Window_System) for Windows.

If you're not hugely familiar with X or Windowing systems, it's basically just a way of displaying applications outside of a terminal.

In our case, while Emacs renders perfectly fine in the terminal, I like to have it render in its own window, which is what a windowing system provides more or less.

There are plenty of other X servers for Windows but I found this one to be pretty seamless. [VcXsrv](https://sourceforge.net/projects/vcxsrv/) is another popular alternative, although I had some configuration troubles getting it working.

That said, I've done some fiddling and have provided a setup guide for it as well!

Before we get started, feel free to skip the entire window manager portion if you're comfortable with, or prefer, running Emacs in your terminal of course.

# The paid, but pretty seamless way

I should stress that while I've opted to purchase an X server that has some extra bits and pieces, you can use an open source, unpaid alternative.

X410 had some decent recommendations for being an easy setup, and happened to be under a very steep discount so I figured I'd give it a spin. I also ran into some issues with VcXsrv originally as well.

You can find it [in the Windows Store](https://www.microsoft.com/store/productId/9NLP712ZMN9Q), presumably for any region. It'll require a Microsoft account to purchase which can be a little annoying if you don't already have one.

The installation should be straight forward and I don't remember any flags that require toggling.

Once you've got it installed, fire it up and you should see a silver X icon in your Windows task tray, in the bottom right of your screen.

You'll need to click on it (left or right, it makes no difference) and select "Allow Public Access"

While the original WSL1 exposes things on `http://localhost` (from memory anyway), WSL2 is treated like a network storage.

This means that our Linux distribution is effectively its own "computer" with its own IP address, and so firewall policies come into place, and so on.

When we connect to our X server, it'll be on an internal address such as 172.x.x.x rather than 127.0.0.1.

Beyond that, we should be good to go! You can either read the alternative setup or skip on down to configuring your `DISPLAY` environment variable.

# The free, open source, slightly more involved way

I'll write this part in a bit. [Send me an email](https://utf9k.net/about) if it's been a few days and I've forgotten!

# Configuring your environment

As I briefly referenced in the setup steps for X410, WSL2 is treated as a network device of sorts.

The exact details are besides the point here but just know that WSL2 is effectively a separate computer.

What this means, is that we can't rely on Emacs automatically knowing where to find our X display server (if you're opting to use one)

It'll check inside of our Linux distribution, but we need to point it to our Windows host, since that's where our X server is running.

Doing so is only one step thankfully:

```
export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2; exit;}'):0.0
```

Ok, easy enough but what just happened?

By default, you'll have an `/etc/resolv.conf` generated by WSL. Here's what mine looks like on a relatively fresh installation:

```
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.31.96.1
```

That IP address there, `172.31.96.1`, is the IP address for our Window host machine. At least, from WSL's point of view anyway.

We can use `grep` to get the exact line we want:

```
marcus@corbenik:~/code/utf9k$ cat /etc/resolv.conf | grep nameserver
nameserver 172.31.96.1
```

and then use `awk` to get just the IP address by itself:

```
marcus@corbenik:~/code/utf9k$ cat /etc/resolv.conf | grep nameserver | awk '{print $2; exit;}'
172.31.96.1
```

Voila! One IP address. What our above command ends up evaluating to, is the following:

```
export DISPLAY=172.31.96.1:0.0
```

That IP address can change from time to time however, which is why we want to automate setting it each time.

Our `DISPLAY` environment variable will go away with each new shell so make sure you put it in your shell startup!

All that's let is to check that we can connect as expected. Here's a connection test against X410, using `nc` (netcat)

```
marcus@corbenik:~/code/utf9k$ nc -v 172.31.96.1 6000
Connection to 172.31.96.1 6000 port [tcp/x11] succeeded!
```

Why do we use port 6000? It's the first in a range of ports for X window servers, which range from 6000 - 6063. If you note the `0.0` on the end of our `DISPLAY` variable, we're telling it to use display 0, screen 0.

If we wanted to use a different display, or perhaps having a second X server may qualify, we could connect to `<address>:1.0` for display 1, screen 0. Under the hood, that would live on port 6001, which is the base port of 6000 added to our display numbe r (1 in this case).

I didn't really know any of that until writing this so I'd encourage you to do your own research if you want to know more, or double check anything I just claimed, haha.

# Installing Emacs

Now then, we need an actual Emacs distribution but don't get too trigger happy just yet. For the most part, running `sudo apt-get install emacs` will give you an outdated package. In reality, it's probably Emacs 25 which is more than fine.

If you'd like to run a more up to date version, you can do the following to fetch a copy of Emacs 26. If you'd like to be on the bleeding edge (and is what Doom Emacs recommends), you'll probably need to compile Emacs 27 from source :(

```
sudo add-apt-repository ppa:kelleyk/emacs
sudo apt-get update
sudo apt-get install emacs26
```

Very nice, you should be all good to go. If you'd like to use Doom Emacs as I am, you'll need some extra packages which you can find more info about [via the handy documentation](https://github.com/hlissner/doom-emacs/blob/develop/docs/getting_started.org#ubuntu)

If you'd like to run Emacs in your terminal, just simply fire up `emacs`. If you'd like to run it on your Windows host, and have your X server running and set up, you can run `emacs &` to spawn it, and keep it open as a background process.

Happy text manipulation!
