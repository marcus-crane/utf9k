<!DOCTYPE html>
<html><head><meta property="og:type" content="website">
<meta property="og:url" content="http://localhost:3000/blog/-tidying-towing-data/">
<meta name="twitter:card" content="summary">
</head><body><p>{{% notice title="I am not a lawyer! Oh, I meant to say data scientist" %}}
I came across this post in an archive folder, fully written out as you see below but never published.</p>
<p>I'm not a data analyst or even really proficient in Pandas by any stretch of the imagination so don't take any of the below as best practice.</p>
<p {%="" notice="" %="">What I can claim however is that it worked, more or less, so you're welcome to code along.</p>
<p>This will be a pretty lengthy blog post detailing how I took an XLSX spreadsheet with towing data and cleaned it up to be (mostly) machine readable.</p>
<p>My ultimate goal is to transform it into a fancy data visualisation. I know roughly how to get there but getting there is tedious.</p>
<p>Rather than leave code snippets lying around my hard drive, I've decided to share what I've accomplished so far.</p>
<p>That and I'm going to forget how to do any of this if I don't explain it step by step!</p>
<h2>Getting the data</h2>
<p>This is the first, and sometimes hardest step. My advice is to be as explicit as is reasonable when requesting the data. It's helpful to be particular about what metadata you're after, and it'll help you if you request to receive it in a machine readable format.</p>
<p>In my case, I received an XLSX file. Not as ideal as a CSV or GeoJSON but also better than receiving a PDF!</p>
<p>You can see my original request and even get a copy of the data <a href="https://fyi.org.nz/request/11018-request-of-towing-data-for-three-tamaki-makaurau-police-districts#incoming-39588">here</a></p>
<h2>Parsing the data</h2>
<p>First, we need to see what we've actually got to work with and then we can parse it into a nicer format.</p>
<pre><code class="language-bash hljs">&gt; <span class="hljs-built_in">ls</span>
Marcus Aug 2016 Jul 2019.xlsx
&gt; <span class="hljs-built_in">mv</span> Marcus\ Aug\ 2016\ Jul\ 2019.xlsx towing.xlsx
&gt; <span class="hljs-built_in">head</span> -n 1 towing.xlsx 
P!??@?6??[Content_Types].xml ??(??YMo?@?W???Z?eM?&amp;?C??m??R??+??YR??]/?Q<span class="hljs-string">"?)s?w?{??ߌ???F7?xT?̘??,S?J?????1:gi*?X3?d????7[???g??}?????:0???z-C????r%????????0aZ
                                                                           6?~??\7!???_??*ò??u-ՌI?U???;S=!??B?P?r?#t?΃??ɝW??_10d? ????????$
                                                           k??C
                                                               ?????Q??????WdW҇?R??????_?Z??_?{4?r-????Z?&lt;?}&lt;??6??SǤ?"</span>DP2&amp;<span class="hljs-string">"???"</span>䜊??T??B榙9?	c?D?D????Cub??kx?}??b?6pr	s?}%??:?/?®?7;*vYPq???;P?1&lt;5??tI?3Y???J?G?????Q132B??d??L??b?ST\????.v????@<span class="hljs-string">"???????P!^?e??jT??=|P??u?G;?8??O?dv
                         ?_rels/.rels ??(????N?0
                                                ??H?C???n ???]&amp;??*`????Q?A??$?F??؟???)??8??|h?*??r)?j6???|)W?R???`ϖ?&lt;Q????j?L=?4???\lP???=?Ѐ!cG6u*????58???&lt;???COq0J?????&lt;??yٛ??մg}??3+??H֐Y9??|l?5?D_STҰ~J??\??%?'?\N???0PD?A??y?O???r?刦??t???w???????c?&lt;,???F?ɷ,&gt;??P!ωkE%??xl/_rels/workbook.xml.rels ??(??XMo?0?#?"</span>߉?3?E????z?<span class="hljs-string">"q??&amp;??C?
          ??Z??
</span></code></pre>
<p>Well, that's not going to work! We need to use some tools that can actually parse this data. For that, I'm going to use <a href="https://pandas.pydata.org/">Pandas</a>, a data analysis library for Python.</p>
<p>This blog post isn't intended to teach you how to use Pandas, but I'll be specific enough that you should be able to follow along with the provided dataset yourself.</p>
<p>Pandas has support for importing Excel spreadsheets by using the <a href="https://xlrd.readthedocs.io/en/latest/">xlrd</a> library so let's install both. We'll also fetch sqlite3 which we'll use near the end:</p>
<pre><code class="language-bash hljs">&gt; pip install pandas xlrd sqlite3
Collecting pandas
[...]
Installing collected packages: numpy, pandas, xlrd
Successfully installed numpy-1.18.1 pandas-0.25.3 xlrd-1.2.0
</code></pre>
<p>Time to import our Excel spreadsheet into a Pandas dataframe but there's a bit of a catch first:</p>
<pre><code class="language-python hljs">&gt; python
Python <span class="hljs-number">3.8</span><span class="hljs-number">.0</span> (default, Dec  <span class="hljs-number">1</span> <span class="hljs-number">2019</span>, <span class="hljs-number">12</span>:<span class="hljs-number">43</span>:<span class="hljs-number">25</span>) 
[Clang <span class="hljs-number">10.0</span><span class="hljs-number">.1</span> (clang-<span class="hljs-number">1001.0</span><span class="hljs-number">.46</span><span class="hljs-number">.4</span>)] on darwin
<span class="hljs-type">Type</span> <span class="hljs-string">"help"</span>, <span class="hljs-string">"copyright"</span>, <span class="hljs-string">"credits"</span> <span class="hljs-keyword">or</span> <span class="hljs-string">"license"</span> <span class="hljs-keyword">for</span> more information.
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-meta">&gt;&gt;&gt; </span>workbook = pd.ExcelFile(<span class="hljs-string">'~/Downloads/towing.xlsx'</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>workbook.sheet_names
[<span class="hljs-string">'Aug 16'</span>, <span class="hljs-string">'Sep 16'</span>, <span class="hljs-string">'Oct 16'</span>, <span class="hljs-string">'Nov 16'</span>, <span class="hljs-string">'Dec 16'</span>, <span class="hljs-string">'Jan 17'</span>, <span class="hljs-string">'Feb 17'</span>, <span class="hljs-string">'Mar 17'</span>, <span class="hljs-string">'Apr 17'</span>, <span class="hljs-string">'May 17'</span>, <span class="hljs-string">'Jun 17'</span>, <span class="hljs-string">'Jul 17'</span>, <span class="hljs-string">'Aug 17'</span>, <span class="hljs-string">'Sep 17'</span>, <span class="hljs-string">'Oct 17'</span>, <span class="hljs-string">'Nov 17'</span>, <span class="hljs-string">'Dec 17'</span>, <span class="hljs-string">'Jan 18'</span>, <span class="hljs-string">'Feb 18'</span>, <span class="hljs-string">'Mar 18'</span>, <span class="hljs-string">'Apr 18'</span>, <span class="hljs-string">'May 18'</span>, <span class="hljs-string">'Jun 18'</span>, <span class="hljs-string">'Jul 18'</span>, <span class="hljs-string">'Aug 18'</span>, <span class="hljs-string">'Sep 18'</span>, <span class="hljs-string">'Oct 18'</span>, <span class="hljs-string">'Nov 18'</span>, <span class="hljs-string">'Dec 18'</span>, <span class="hljs-string">'Jan 19'</span>, <span class="hljs-string">'Feb 19'</span>, <span class="hljs-string">'Mar 19'</span>, <span class="hljs-string">'Apr 19'</span>, <span class="hljs-string">'May 19'</span>, <span class="hljs-string">'Jun 19'</span>, <span class="hljs-string">'Jul 19'</span>]
</code></pre>
<p>Our workbook is not one big sheet but in fact, one sheet per month. For those of you who don't use Excel (ie me), sheets are those tabs at the bottom of the application. Usually you'll just see "Sheet 1" when viewing a blank spreadsheet.</p>
<p>We still need to parse each sheet, one by one, in order to get a complete collection of data. To do so, we'll just iterate over each sheet and append it to an initially empty data frame:</p>
<pre><code class="language-python hljs">&gt; python
Python <span class="hljs-number">3.8</span><span class="hljs-number">.0</span> (default, Dec  <span class="hljs-number">1</span> <span class="hljs-number">2019</span>, <span class="hljs-number">12</span>:<span class="hljs-number">43</span>:<span class="hljs-number">25</span>) 
[Clang <span class="hljs-number">10.0</span><span class="hljs-number">.1</span> (clang-<span class="hljs-number">1001.0</span><span class="hljs-number">.46</span><span class="hljs-number">.4</span>)] on darwin
<span class="hljs-type">Type</span> <span class="hljs-string">"help"</span>, <span class="hljs-string">"copyright"</span>, <span class="hljs-string">"credits"</span> <span class="hljs-keyword">or</span> <span class="hljs-string">"license"</span> <span class="hljs-keyword">for</span> more information.
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-meta">&gt;&gt;&gt; </span>workbook = pd.ExcelFile(<span class="hljs-string">"~/Downloads/towing.xlsx"</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>df = pd.DataFrame()
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> sheet_name <span class="hljs-keyword">in</span> workbook.sheet_names:
<span class="hljs-meta">... </span>    sheet = workbook.parse(sheet_name=sheet_name)
<span class="hljs-meta">... </span>    df = df.append(sheet, sort=<span class="hljs-literal">False</span>)
<span class="hljs-meta">... </span>
<span class="hljs-meta">&gt;&gt;&gt; </span>df
     Unnamed: <span class="hljs-number">0</span>        Date <span class="hljs-keyword">and</span> Time   ... Unnamed: <span class="hljs-number">9</span> Unnamed: <span class="hljs-number">10</span>
<span class="hljs-number">0</span>           NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">1</span>           NaN   Monday, 01 Aug <span class="hljs-number">2016</span>  ...        NaN         NaN
<span class="hljs-number">2</span>           NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">3</span>           NaN            08:<span class="hljs-number">34</span> a.m.  ...        NaN         NaN
<span class="hljs-number">4</span>           NaN            <span class="hljs-number">10</span>:06 a.m.  ...        NaN         NaN
<span class="hljs-meta">... </span>        ...                   ...  ...        ...         ...
<span class="hljs-number">1754</span>        NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">1755</span>        NaN  Tuesday, <span class="hljs-number">23</span> Jul <span class="hljs-number">2019</span>  ...        NaN         NaN
<span class="hljs-number">1756</span>        NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">1757</span>        NaN            09:05 p.m.  ...        NaN         NaN
<span class="hljs-number">1758</span>        NaN                   NaN  ...        NaN         NaN

[<span class="hljs-number">64160</span> rows x <span class="hljs-number">11</span> columns]
</code></pre>
<p>There we go, all 64,000 rows in one nice data frame we can reason about!</p>
<p>We've still got a long way to go however as we don't have a nice index, nor do we even have anywhere remotely consistent data.</p>
<h2>Cleaning up the data</h2>
<p>First, let's have a closer look at our data by printing the first 25 rows:</p>
<pre><code class="language-python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>df[<span class="hljs-number">0</span>:<span class="hljs-number">25</span>]
   Unnamed: <span class="hljs-number">0</span>        Date <span class="hljs-keyword">and</span> Time   ... Unnamed: <span class="hljs-number">9</span> Unnamed: <span class="hljs-number">10</span>
<span class="hljs-number">0</span>         NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">1</span>         NaN   Monday, 01 Aug <span class="hljs-number">2016</span>  ...        NaN         NaN
<span class="hljs-number">2</span>         NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">3</span>         NaN            08:<span class="hljs-number">34</span> a.m.  ...        NaN         NaN
<span class="hljs-number">4</span>         NaN            <span class="hljs-number">10</span>:06 a.m.  ...        NaN         NaN
<span class="hljs-number">5</span>         NaN            <span class="hljs-number">10</span>:<span class="hljs-number">42</span> a.m.  ...        NaN         NaN
<span class="hljs-number">6</span>         NaN            <span class="hljs-number">11</span>:<span class="hljs-number">49</span> a.m.  ...        NaN         NaN
<span class="hljs-number">7</span>         NaN            01:<span class="hljs-number">18</span> p.m.  ...        NaN         NaN
<span class="hljs-number">8</span>         NaN            04:09 p.m.  ...        NaN         NaN
<span class="hljs-number">9</span>         NaN            04:<span class="hljs-number">10</span> p.m.  ...        NaN         NaN
<span class="hljs-number">10</span>        NaN            04:<span class="hljs-number">17</span> p.m.  ...        NaN         NaN
<span class="hljs-number">11</span>        NaN            04:<span class="hljs-number">21</span> p.m.  ...        NaN         NaN
<span class="hljs-number">12</span>        NaN            04:<span class="hljs-number">31</span> p.m.  ...        NaN         NaN
<span class="hljs-number">13</span>        NaN            04:<span class="hljs-number">40</span> p.m.  ...        NaN         NaN
<span class="hljs-number">14</span>        NaN            04:<span class="hljs-number">44</span> p.m.  ...        NaN         NaN
<span class="hljs-number">15</span>        NaN            04:<span class="hljs-number">57</span> p.m.  ...        NaN         NaN
<span class="hljs-number">16</span>        NaN            08:<span class="hljs-number">17</span> p.m.  ...        NaN         NaN
<span class="hljs-number">17</span>        NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">18</span>        NaN  Tuesday, 02 Aug <span class="hljs-number">2016</span>  ...        NaN         NaN
<span class="hljs-number">19</span>        NaN                   NaN  ...        NaN         NaN
<span class="hljs-number">20</span>        NaN            02:04 a.m.  ...        NaN         NaN
<span class="hljs-number">21</span>        NaN            <span class="hljs-number">10</span>:<span class="hljs-number">50</span> a.m.  ...        NaN         NaN
<span class="hljs-number">22</span>        NaN            <span class="hljs-number">11</span>:<span class="hljs-number">41</span> a.m.  ...        NaN         NaN
<span class="hljs-number">23</span>        NaN            02:<span class="hljs-number">32</span> p.m.  ...        NaN         NaN
<span class="hljs-number">24</span>        NaN            04:<span class="hljs-number">13</span> p.m.  ...        NaN         NaN

[<span class="hljs-number">25</span> rows x <span class="hljs-number">11</span> columns]
</code></pre>
<p>Focusing on the date column, there's a pattern that sticks out. The data is actually grouped visually by day like so:</p>
<pre><code>[empty cell]
Monday, 01 Aug 2016
[empty cell]
08:34 a.m.
[...]
08:17 p.m.
[empty cell]
Tuesday, 02 Aug 2016
[empty cell]
02:04 a.m.
</code></pre>
<p>There's no consistency from a machine readable point of view so we'll have to clean it up into something more consistent manually. Before we do that, let's get some column headings.</p>
<pre><code class="language-python hljs">&gt; <span class="hljs-keyword">from</span> pprint <span class="hljs-keyword">import</span> pprint
&gt; pprint(<span class="hljs-built_in">list</span>(df.columns))
[<span class="hljs-string">'Unnamed: 0'</span>,
 <span class="hljs-string">'Date and Time '</span>,
 <span class="hljs-string">'Vehicle '</span>,
 <span class="hljs-string">'Towed From '</span>,
 <span class="hljs-string">'Towed Too '</span>,
 <span class="hljs-string">'Unnamed: 5'</span>,
 <span class="hljs-string">'Unnamed: 6'</span>,
 <span class="hljs-string">'Unnamed: 7'</span>,
 <span class="hljs-string">'Unnamed: 8'</span>,
 <span class="hljs-string">'Unnamed: 9'</span>,
 <span class="hljs-string">'Unnamed: 10'</span>]
</code></pre>
<p>That's a lot of columns.</p>
<p>After a quick skim of the dataset, we can see that only <code>Unnamed: 5</code> is used. We'll discard the unused columns and then clean up the remaining data:</p>
<pre><code class="language-python hljs">&gt; df = df.drop(columns=[<span class="hljs-string">'Unnamed: 0'</span>, <span class="hljs-string">'Unnamed: 6'</span>, <span class="hljs-string">'Unnamed: 7'</span>, <span class="hljs-string">'Unnamed: 8'</span>, <span class="hljs-string">'Unnamed: 9'</span>, <span class="hljs-string">'Unnamed: 10'</span>])
<span class="hljs-meta">&gt;&gt;&gt; </span>df
            Date <span class="hljs-keyword">and</span> Time          Vehicle   ...       Towed Too  Unnamed: <span class="hljs-number">5</span>
<span class="hljs-number">0</span>                      NaN              NaN  ...              NaN        NaN
<span class="hljs-number">1</span>      Monday, 01 Aug <span class="hljs-number">2016</span>              NaN  ...              NaN         <span class="hljs-number">55</span>
<span class="hljs-number">2</span>                      NaN              NaN  ...              NaN         <span class="hljs-number">55</span>
<span class="hljs-number">3</span>               08:<span class="hljs-number">34</span> a.m.  TOYOTA FUNCARGO  ...   <span class="hljs-number">2</span> PUKEHANA AVE         <span class="hljs-number">55</span>
<span class="hljs-number">4</span>               <span class="hljs-number">10</span>:06 a.m.          AUDI A3  ...  30A CROMWELL ST         <span class="hljs-number">55</span>
<span class="hljs-meta">... </span>                   ...              ...  ...              ...        ...
<span class="hljs-number">1754</span>                   NaN              NaN  ...       Total    <span class="hljs-number">1</span>      Romeo
<span class="hljs-number">1755</span>  Tuesday, <span class="hljs-number">23</span> Jul <span class="hljs-number">2019</span>              NaN  ...              NaN      Romeo
<span class="hljs-number">1756</span>                   NaN              NaN  ...              NaN      Romeo
<span class="hljs-number">1757</span>            09:05 p.m.   TOYOTA, ESTIMA  ...     <span class="hljs-number">7</span> FLAVELL DR      Romeo
<span class="hljs-number">1758</span>                   NaN              NaN  ...       Total    <span class="hljs-number">1</span>      Romeo
</code></pre>
<p>It's starting to look more reasonable. Now let's assign some appropriate names. You can't quite tell from the code snippets but there's actually some rogue whitespace in the columns so I opened to rename all of them for consistency:</p>
<pre><code class="language-python hljs">&gt; df = df.rename(columns={<span class="hljs-string">'Unnamed: 5'</span>: <span class="hljs-string">'Suburb'</span>, <span class="hljs-string">'Date and Time '</span>: <span class="hljs-string">'Date'</span>, <span class="hljs-string">'Towed From '</span>: <span class="hljs-string">'Origin'</span>, <span class="hljs-string">'Towed Too '</span>: <span class="hljs-string">'Destination'</span>, <span class="hljs-string">'Vehicle '</span>: <span class="hljs-string">'Vehicle'</span>})
<span class="hljs-meta">&gt;&gt;&gt; </span>df
                      Date          Vehicle  ...      Destination Suburb
<span class="hljs-number">0</span>                      NaN              NaN  ...              NaN    NaN
<span class="hljs-number">1</span>      Monday, 01 Aug <span class="hljs-number">2016</span>              NaN  ...              NaN     <span class="hljs-number">55</span>
<span class="hljs-number">2</span>                      NaN              NaN  ...              NaN     <span class="hljs-number">55</span>
<span class="hljs-number">3</span>               08:<span class="hljs-number">34</span> a.m.  TOYOTA FUNCARGO  ...   <span class="hljs-number">2</span> PUKEHANA AVE     <span class="hljs-number">55</span>
<span class="hljs-number">4</span>               <span class="hljs-number">10</span>:06 a.m.          AUDI A3  ...  30A CROMWELL ST     <span class="hljs-number">55</span>
<span class="hljs-meta">... </span>                   ...              ...  ...              ...    ...
<span class="hljs-number">1754</span>                   NaN              NaN  ...       Total    <span class="hljs-number">1</span>  Romeo
<span class="hljs-number">1755</span>  Tuesday, <span class="hljs-number">23</span> Jul <span class="hljs-number">2019</span>              NaN  ...              NaN  Romeo
<span class="hljs-number">1756</span>                   NaN              NaN  ...              NaN  Romeo
<span class="hljs-number">1757</span>            09:05 p.m.   TOYOTA, ESTIMA  ...     <span class="hljs-number">7</span> FLAVELL DR  Romeo
<span class="hljs-number">1758</span>                   NaN              NaN  ...       Total    <span class="hljs-number">1</span>  Romeo
</code></pre>
<p>Even better! We're almost in a position to start parsing our dates into valid timestamps.</p>
<h2>Performing some data fixes</h2>
<p>Here's the part that was the most difficult, which I've already done for you thankfully.</p>
<p>Basically, I wrote some code to parse the dates into timestamps and it would keep breaking. I'd fix the offending piece of data, run it again and see where it broke next. I'd keep doing that until the script ran to completion.</p>
<p>Here are the following data fixes, provided so you can follow along entirely with my process:</p>
<pre><code class="language-python hljs">df = df.replace(<span class="hljs-string">'Sunda, 28 Aug 2016'</span>, <span class="hljs-string">'Sunday, 28 Aug 2016'</span>)
df = df.replace(<span class="hljs-string">'Satruday, 06 Jan 2017'</span>, <span class="hljs-string">'Saturday, 06 Jan 2017'</span>)
df = df.replace(<span class="hljs-string">'Tuesday, 28th Nov '</span>, <span class="hljs-string">'Tuesday, 28 Nov 2017'</span>)
df = df.replace(<span class="hljs-string">'4.40pm'</span>, <span class="hljs-string">'4:40pm'</span>)
df = df.replace(<span class="hljs-string">'5.08pm'</span>, <span class="hljs-string">'5:08pm'</span>)
df = df.replace(<span class="hljs-string">'14:55 pm'</span>, <span class="hljs-string">'2:55pm'</span>)
df = df.replace(<span class="hljs-string">'4.37 p.m.'</span>, <span class="hljs-string">'4:37pm'</span>)
df = df.replace(<span class="hljs-string">'17:01 p.m'</span>, <span class="hljs-string">'5:01pm'</span>)
df = df.replace(<span class="hljs-string">'4.22 p.m.'</span>, <span class="hljs-string">'4:22pm'</span>)
df = df.replace(<span class="hljs-string">'4.32 p.m.'</span>, <span class="hljs-string">'4:32pm'</span>)
</code></pre>
<h2>Transforming dates into valid timestamps</h2>
<p>Now that our data is in much better shape, we can tackle arguably the part that really got me thinking. It wasn't difficult in a blood, sweat and tears kind of way but was definitely a stretch.</p>
<p>Before I walk you through what I settled for, I'll caveat that there may be more ideal ways of doing this. What I wrote got the job done and that's all I cared about ;)</p>
<p>Since our date column includes pseudo-headings, I realised I can just pass over the whole column once.</p>
<p>If the word <code>day</code> is in a column (as it would be in every heading), we can use that cell to determine the date we've gotten up to. Any time below that cell implicitly refers to that date so we can merge it into the following cells.</p>
<p>Here's a visual example of what I mean:</p>
<table>
<thead>
<tr>
<th>Before</th>
<th>After</th>
</tr>
</thead>
<tbody>
<tr>
<td>Monday, 01 Aug 2016</td>
<td>Monday, 01 Aug 2016</td>
</tr>
<tr>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>8:34 a.m.</td>
<td>Monday, 01 Aug 2016 8:34 a.m.</td>
</tr>
<tr>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>Tuesday, 23 Jul 2019</td>
<td>Tuesday, 23 Jul 2019</td>
</tr>
<tr>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>4:00 a.m.</td>
<td>Tuesday, 23 Jul 2019 4:00 a.m.</td>
</tr>
<tr>
<td>9:42 p.m.</td>
<td>Tuesday 23 Jul 2019 9:42 p.m.</td>
</tr>
</tbody>
</table>
<p>The goal here isn't to get super accurate timestamps just yet, but rather something good enough that is consistent and therefore parsable. The rest of the mess, such as those <code>NaN</code> are trivial to get rid of later.</p>
<p>Anyway, here's the shortest possible version of the code required that I came up with:</p>
<pre><code class="language-python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>current_date = <span class="hljs-string">''</span>
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> idx, entry <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(df[<span class="hljs-string">'Date'</span>]):
<span class="hljs-meta">... </span>    item = <span class="hljs-built_in">str</span>(entry)
<span class="hljs-meta">... </span>    <span class="hljs-keyword">if</span> <span class="hljs-string">'day'</span> <span class="hljs-keyword">in</span> item:
<span class="hljs-meta">... </span>            current_date = item
<span class="hljs-meta">... </span>    <span class="hljs-keyword">if</span> <span class="hljs-string">'day'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> item <span class="hljs-keyword">and</span> item != <span class="hljs-string">'nan'</span>:
<span class="hljs-meta">... </span>            df.iloc[idx][<span class="hljs-string">'Date'</span>] = pd.to_datetime(<span class="hljs-string">f'<span class="hljs-subst">{current_date}</span> <span class="hljs-subst">{item}</span>'</span>)
...
</code></pre>
<p>It'll take a little bit to run, as it has to iterate over every row but it leaves us with something pretty promising:</p>
<pre><code class="language-python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>df
                      Date          Vehicle  ...      Destination Suburb
<span class="hljs-number">0</span>                      NaN              NaN  ...              NaN    NaN
<span class="hljs-number">1</span>      Monday, 01 Aug <span class="hljs-number">2016</span>              NaN  ...              NaN     <span class="hljs-number">55</span>
<span class="hljs-number">2</span>                      NaN              NaN  ...              NaN     <span class="hljs-number">55</span>
<span class="hljs-number">3</span>      <span class="hljs-number">2016</span>-08-01 08:<span class="hljs-number">34</span>:<span class="hljs-number">00</span>  TOYOTA FUNCARGO  ...   <span class="hljs-number">2</span> PUKEHANA AVE     <span class="hljs-number">55</span>
<span class="hljs-number">4</span>      <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">10</span>:06:<span class="hljs-number">00</span>          AUDI A3  ...  30A CROMWELL ST     <span class="hljs-number">55</span>
<span class="hljs-meta">... </span>                   ...              ...  ...              ...    ...
<span class="hljs-number">1754</span>                   NaN              NaN  ...       Total    <span class="hljs-number">1</span>  Romeo
<span class="hljs-number">1755</span>  Tuesday, <span class="hljs-number">23</span> Jul <span class="hljs-number">2019</span>              NaN  ...              NaN  Romeo
<span class="hljs-number">1756</span>                   NaN              NaN  ...              NaN  Romeo
<span class="hljs-number">1757</span>   <span class="hljs-number">2019</span>-07-<span class="hljs-number">23</span> <span class="hljs-number">21</span>:05:<span class="hljs-number">00</span>   TOYOTA, ESTIMA  ...     <span class="hljs-number">7</span> FLAVELL DR  Romeo
<span class="hljs-number">1758</span>                   NaN              NaN  ...       Total    <span class="hljs-number">1</span>  Romeo

[<span class="hljs-number">64160</span> rows x <span class="hljs-number">5</span> columns]
</code></pre>
<p>Ok, I lied earlier. We use the <code>pd.to_datetime</code> function earlier to generate entirely valid timestamps. All that's left is to get rid of those intermediary cells and we should have some fresh data ready to operate on.</p>
<pre><code class="language-python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>df = df.dropna()
<span class="hljs-meta">&gt;&gt;&gt; </span>df[<span class="hljs-number">0</span>:<span class="hljs-number">25</span>]
                   Date            Vehicle  ...      Destination Suburb
<span class="hljs-number">3</span>   <span class="hljs-number">2016</span>-08-01 08:<span class="hljs-number">34</span>:<span class="hljs-number">00</span>    TOYOTA FUNCARGO  ...   <span class="hljs-number">2</span> PUKEHANA AVE     <span class="hljs-number">55</span>
<span class="hljs-number">4</span>   <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">10</span>:06:<span class="hljs-number">00</span>            AUDI A3  ...  30A CROMWELL ST     <span class="hljs-number">55</span>
<span class="hljs-number">5</span>   <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">10</span>:<span class="hljs-number">42</span>:<span class="hljs-number">00</span>        MAZDA DEMIO  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">6</span>   <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">11</span>:<span class="hljs-number">49</span>:<span class="hljs-number">00</span>    TOYOTA VANGUARD  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">7</span>   <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">13</span>:<span class="hljs-number">18</span>:<span class="hljs-number">00</span>        TOYOTA VITZ  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">8</span>   <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:09:<span class="hljs-number">00</span>  NISSAN PATHFINDER  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">9</span>   <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    VOLKSWAGEN GOLF  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">10</span>  <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:<span class="hljs-number">17</span>:<span class="hljs-number">00</span>       HONDA ACCORD  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">11</span>  <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">00</span>  TOYOTA HIGHLANDER  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">12</span>  <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:<span class="hljs-number">31</span>:<span class="hljs-number">00</span>        TOYOTA RAV4  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">13</span>  <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:<span class="hljs-number">40</span>:<span class="hljs-number">00</span>          HONDA FIT  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">14</span>  <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:<span class="hljs-number">44</span>:<span class="hljs-number">00</span>      TOYOTA CELICA  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">15</span>  <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">16</span>:<span class="hljs-number">57</span>:<span class="hljs-number">00</span>   HOLDEN COMMODORE  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">16</span>  <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">20</span>:<span class="hljs-number">17</span>:<span class="hljs-number">00</span>      TOYOTA TRUENO  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">20</span>  <span class="hljs-number">2016</span>-08-02 02:04:<span class="hljs-number">00</span>         HONDA JAZZ  ...      <span class="hljs-number">3</span> KORARI ST     <span class="hljs-number">55</span>
<span class="hljs-number">21</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">00</span>      TOYOTA CARINA  ...       HENDON AVE     <span class="hljs-number">55</span>
<span class="hljs-number">22</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">11</span>:<span class="hljs-number">41</span>:<span class="hljs-number">00</span>        MAZDA DEMIO  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">23</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">14</span>:<span class="hljs-number">32</span>:<span class="hljs-number">00</span>     TOYOTA COROLLA  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">24</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">00</span>      NISSAN PULSAR  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">25</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">16</span>:<span class="hljs-number">21</span>:<span class="hljs-number">00</span>             BMW X3  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">26</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">16</span>:<span class="hljs-number">23</span>:<span class="hljs-number">00</span>    VOLKSWAGEN GOLF  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">27</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">16</span>:<span class="hljs-number">23</span>:<span class="hljs-number">00</span>         CITROEN C3  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">28</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">16</span>:<span class="hljs-number">40</span>:<span class="hljs-number">00</span>      VMOTO SCOOTER  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">29</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">16</span>:<span class="hljs-number">57</span>:<span class="hljs-number">00</span>       SUZUKI SWIFT  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>
<span class="hljs-number">30</span>  <span class="hljs-number">2016</span>-08-02 <span class="hljs-number">18</span>:<span class="hljs-number">54</span>:<span class="hljs-number">00</span>      NISSAN NAVARA  ...   <span class="hljs-number">230</span> SYMONDS ST     <span class="hljs-number">55</span>

[<span class="hljs-number">25</span> rows x <span class="hljs-number">5</span> columns]
</code></pre>
<p>Looks good to me!</p>
<h3>Final cleanup</h3>
<p>Oh, one last thing. You'll see all of those numbers under the suburb section that don't appear to mean anything. The correspondence that came with the dataset explains what those represent. Let's quickly convert them into something human readable.</p>
<pre><code class="language-python hljs">df[<span class="hljs-string">'Suburb'</span>] = df[<span class="hljs-string">'Suburb'</span>].replace(<span class="hljs-number">55</span>, <span class="hljs-string">'CENTRAL'</span>)
df[<span class="hljs-string">'Suburb'</span>] = df[<span class="hljs-string">'Suburb'</span>].replace(<span class="hljs-number">66</span>, <span class="hljs-string">'NORTHERN'</span>)
df[<span class="hljs-string">'Suburb'</span>] = df[<span class="hljs-string">'Suburb'</span>].replace(<span class="hljs-number">77</span>, <span class="hljs-string">'WESTERN'</span>)
df[<span class="hljs-string">'Suburb'</span>] = df[<span class="hljs-string">'Suburb'</span>].replace(<span class="hljs-number">88</span>, <span class="hljs-string">'SOUTHERN'</span>)
df[<span class="hljs-string">'Suburb'</span>] = df[<span class="hljs-string">'Suburb'</span>].replace(<span class="hljs-number">99</span>, <span class="hljs-string">'CBD'</span>)
df[<span class="hljs-string">'Suburb'</span>] = df[<span class="hljs-string">'Suburb'</span>].replace(<span class="hljs-string">'Romeo'</span>, <span class="hljs-string">'RURAL'</span>)
</code></pre>
<p>Here's the final result after all of our hard work beating the dataset into shape:</p>
<pre><code class="language-python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>df
                     Date           Vehicle  ...            Destination   Suburb
<span class="hljs-number">3</span>     <span class="hljs-number">2016</span>-08-01 08:<span class="hljs-number">34</span>:<span class="hljs-number">00</span>   TOYOTA FUNCARGO  ...         <span class="hljs-number">2</span> PUKEHANA AVE  CENTRAL
<span class="hljs-number">4</span>     <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">10</span>:06:<span class="hljs-number">00</span>           AUDI A3  ...        30A CROMWELL ST  CENTRAL
<span class="hljs-number">5</span>     <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">10</span>:<span class="hljs-number">42</span>:<span class="hljs-number">00</span>       MAZDA DEMIO  ...         <span class="hljs-number">230</span> SYMONDS ST  CENTRAL
<span class="hljs-number">6</span>     <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">11</span>:<span class="hljs-number">49</span>:<span class="hljs-number">00</span>   TOYOTA VANGUARD  ...         <span class="hljs-number">230</span> SYMONDS ST  CENTRAL
<span class="hljs-number">7</span>     <span class="hljs-number">2016</span>-08-01 <span class="hljs-number">13</span>:<span class="hljs-number">18</span>:<span class="hljs-number">00</span>       TOYOTA VITZ  ...         <span class="hljs-number">230</span> SYMONDS ST  CENTRAL
<span class="hljs-meta">... </span>                  ...               ...  ...                    ...      ...
<span class="hljs-number">1744</span>  <span class="hljs-number">2019</span>-07-03 <span class="hljs-number">12</span>:<span class="hljs-number">57</span>:<span class="hljs-number">00</span>  HOLDEN COMMODORE  ...           <span class="hljs-number">18</span> COWLEY PL    RURAL
<span class="hljs-number">1745</span>  <span class="hljs-number">2019</span>-07-03 <span class="hljs-number">13</span>:<span class="hljs-number">45</span>:<span class="hljs-number">00</span>      SUZUKI SWIFT  ...               ADAMS DR    RURAL
<span class="hljs-number">1749</span>  <span class="hljs-number">2019</span>-07-<span class="hljs-number">12</span> <span class="hljs-number">12</span>:01:<span class="hljs-number">00</span>        FIAT PUNTO  ...  <span class="hljs-number">22</span> HENDERSON VALLEY R    RURAL
<span class="hljs-number">1753</span>  <span class="hljs-number">2019</span>-07-<span class="hljs-number">21</span> <span class="hljs-number">13</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>         MAZDA MPV  ...           <span class="hljs-number">61</span> CROOKS RD    RURAL
<span class="hljs-number">1757</span>  <span class="hljs-number">2019</span>-07-<span class="hljs-number">23</span> <span class="hljs-number">21</span>:05:<span class="hljs-number">00</span>    TOYOTA, ESTIMA  ...           <span class="hljs-number">7</span> FLAVELL DR    RURAL

[<span class="hljs-number">49174</span> rows x <span class="hljs-number">5</span> columns]
</code></pre>
<p>While we're nowhere near done just yet, I think this is a good place to cap off this post as moving forward, the dataset will shift out of Pandas as we start to translate towing addresses into tangible GPS coordinates. Once we've got coordinates, we can begin plotting this data on a map.</p>
<p>Personally, I learnt a lot about Pandas by going through this whole ordeal. At first, I thought no way could this data set possibly be cleaned up but with enough head banging, anything is possible!</p>
<h3>Exporting the data</h3>
<p>Rather than just leave this data sitting in memory, let's export it into a <a href="https://www.sqlite.org/index.html">SQLite</a> database so we can play around with it a bit more.</p>
<p>You'll need the <code>sqlite3</code> python package installed which I recommended installing near the top of this post.</p>
<p>We also need to set an index or trying to export the dataset will fail. Not quite sure why but presumably it doesn't know what to do with the default index. I haven't looked into it but we'll just set our timestamps as the new index.</p>
<p>Given that a human is entering this data, I highly doubt any of our timestamps clash. That said, it's always a good idea to choose something truly guaranteed to be unique so consider yourself warned :)</p>
<pre><code class="language-python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>df = df.set_index(<span class="hljs-string">'Date'</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>df
                              Vehicle          Origin            Destination   Suburb
Date                                                                                 
<span class="hljs-number">2016</span>-08-01 08:<span class="hljs-number">34</span>:<span class="hljs-number">00</span>   TOYOTA FUNCARGO       <span class="hljs-number">33</span> PAH RD         <span class="hljs-number">2</span> PUKEHANA AVE  CENTRAL
<span class="hljs-number">2016</span>-08-01 <span class="hljs-number">10</span>:06:<span class="hljs-number">00</span>           AUDI A3  <span class="hljs-number">30</span> CROMWELL ST        30A CROMWELL ST  CENTRAL
<span class="hljs-number">2016</span>-08-01 <span class="hljs-number">10</span>:<span class="hljs-number">42</span>:<span class="hljs-number">00</span>       MAZDA DEMIO       SULTAN LN         <span class="hljs-number">230</span> SYMONDS ST  CENTRAL
<span class="hljs-number">2016</span>-08-01 <span class="hljs-number">11</span>:<span class="hljs-number">49</span>:<span class="hljs-number">00</span>   TOYOTA VANGUARD    <span class="hljs-number">1</span> WAIOHUA RD         <span class="hljs-number">230</span> SYMONDS ST  CENTRAL
<span class="hljs-number">2016</span>-08-01 <span class="hljs-number">13</span>:<span class="hljs-number">18</span>:<span class="hljs-number">00</span>       TOYOTA VITZ       CAWLEY ST         <span class="hljs-number">230</span> SYMONDS ST  CENTRAL
<span class="hljs-meta">... </span>                              ...             ...                    ...      ...
<span class="hljs-number">2019</span>-07-03 <span class="hljs-number">12</span>:<span class="hljs-number">57</span>:<span class="hljs-number">00</span>  HOLDEN COMMODORE     BEVERLEY RD           <span class="hljs-number">18</span> COWLEY PL    RURAL
<span class="hljs-number">2019</span>-07-03 <span class="hljs-number">13</span>:<span class="hljs-number">45</span>:<span class="hljs-number">00</span>      SUZUKI SWIFT        ADAMS DR               ADAMS DR    RURAL
<span class="hljs-number">2019</span>-07-<span class="hljs-number">12</span> <span class="hljs-number">12</span>:01:<span class="hljs-number">00</span>        FIAT PUNTO  <span class="hljs-number">2</span> BERDINNER RD  <span class="hljs-number">22</span> HENDERSON VALLEY R    RURAL
<span class="hljs-number">2019</span>-07-<span class="hljs-number">21</span> <span class="hljs-number">13</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>         MAZDA MPV       PURIRI RD           <span class="hljs-number">61</span> CROOKS RD    RURAL
<span class="hljs-number">2019</span>-07-<span class="hljs-number">23</span> <span class="hljs-number">21</span>:05:<span class="hljs-number">00</span>    TOYOTA, ESTIMA    <span class="hljs-number">9</span> FLAVELL DR           <span class="hljs-number">7</span> FLAVELL DR    RURAL

[<span class="hljs-number">49174</span> rows x <span class="hljs-number">4</span> columns]
</code></pre>
<p>Now we're ready to export it:</p>
<pre><code class="language-python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> sqlite3
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">with</span> sqlite3.connect(<span class="hljs-string">'towing.db'</span>) <span class="hljs-keyword">as</span> conn:
<span class="hljs-meta">... </span>    df.to_sql(<span class="hljs-string">'towing'</span>, conn)
...
</code></pre>
<p>You should now have a file called <code>towing.db</code> sitting in the same directory that you opened your Python REPL.</p>
<p>You might want to use a GUI tool like <a href="https://sqlitebrowser.org/">DB Browser for SQLite</a> to play around with it. You might notice that we've still got some data that isn't quite right and such is the life of data analysis I suppose. I wouldn't know since I'm just a hobbyist, hahaha.</p>
<p>Let's run a sample query to see the top 5 cars just to cap this post off once and for all:</p>
<pre><code class="language-sql hljs"><span class="hljs-keyword">SELECT</span> vehicle, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> count
<span class="hljs-keyword">FROM</span> towing
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> vehicle
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> count DEST
LIMIT <span class="hljs-number">5</span>
</code></pre>
<p>We get the following table back:</p>
<table>
<thead>
<tr>
<th>Vehicle</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>TOYOTA COROLLA</td>
<td>2103</td>
</tr>
<tr>
<td>SUZUKI SWIFT</td>
<td>1602</td>
</tr>
<tr>
<td>NISSAN TILDA</td>
<td>1251</td>
</tr>
<tr>
<td>VOLKSWAGEN GOLF</td>
<td>1146</td>
</tr>
<tr>
<td>HONDA FIT</td>
<td>1089</td>
</tr>
</tbody>
</table>
<p>Very cool. Personally, I'm rubbish at SQL so this should be a fun dataset to experiment with.</p>
</body></html>